{% extends "base.html" %}
{% block content %}


<div class="container-fluid pb-4">

  <!-- PAGE TITLE -->
  <div class="mb-4">
    <h3 class="fw-bold">Admin Dashboard – PIMS Integration</h3>
    <p class="text-muted mb-0">
      ITAM vs Active Services reconciliation overview (Region aligned)
    </p>
  </div>

  <!-- DATA SOURCE CARD -->
  <div class="card shadow-sm mb-4">

    <div class="card-header fw-bold bg-light">
      Data Sources & Reconciliation
    </div>

    <div class="card-body">

      <!-- CURRENT STATE -->
      <div class="row mb-3">

        <div class="col-md-4">
          <small class="text-muted">Selected ITAM Dump</small>
          <div class="fw-semibold">
            {{ itam_file or "Not selected" }}
          </div>
        </div>

        <div class="col-md-4">
          <small class="text-muted">Selected Active Services</small>
          <div class="fw-semibold">
            {{ active_file or "Not selected" }}
          </div>
        </div>

        <div class="col-md-4">
          <small class="text-muted">Last Reconciled</small>
          <div class="fw-semibold">
            {{ reconciled_at or "N/A" }}
          </div>
        </div>

      </div>

      <hr>

      <!-- RECONCILE FORM -->
      <form method="POST" action="/reconcile">
        <div class="row g-3 align-items-end">

          <div class="col-md-5">
            <label class="form-label fw-semibold">
              Select ITAM Dump
            </label>
            <select class="form-select" name="itam_file" required>
              <option value="">-- Select ITAM file --</option>
              {% for f in itam_files %}
                <option value="{{ f }}">{{ f }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-5">
            <label class="form-label fw-semibold">
              Select Active Services Report
            </label>
            <select class="form-select" name="active_file" required>
              <option value="">-- Select Active Services file --</option>
              {% for f in active_files %}
                <option value="{{ f }}">{{ f }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
              Reconcile
            </button>
          </div>

        </div>
      </form>

    </div>
  </div>

  <!-- SUMMARY CARD -->
  <div class="card shadow-sm mb-4">

    <div class="card-header fw-bold bg-light">
      Region & Department Summary
    </div>

    <!-- FILTERS -->
    <div class="card-body border-bottom">
      <div class="row g-2 align-items-end">

        <div class="col-md-3">
          <label class="form-label small fw-semibold">
            Region
          </label>
          <select class="form-select form-select-sm" id="filterRegion">
            <option value="">All Regions</option>
            {% for r in regions %}
              <option value="{{ r | lower }}">{{ r }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label small fw-semibold">
            Department
          </label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="filterDepartment"
            placeholder="Search department..."
          >
        </div>

        <div class="col-md-3">
          <label class="form-label small fw-semibold">
            Pending ≥
          </label>
          <input
            type="number"
            class="form-control form-control-sm"
            id="filterPending"
            min="0"
            placeholder="e.g. 10"
          >
        </div>

        <div class="col-md-3 text-end">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            onclick="resetFilters()"
          >
            Reset
          </button>
          <button
            type="button"
            class="btn btn-outline-primary btn-sm"
            onclick="exportTable()"
          >
            Export CSV
          </button>
        </div>

      </div>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table
        class="table table-bordered table-hover mb-0 align-middle"
        id="summaryTable"
      >

        <thead class="table-dark">
          <tr>
            <th>Region</th>
            <th>Department</th>
            <th>Total Servers</th>
            <th>Integrated</th>
            <th>Pending</th>
          </tr>
        </thead>

        <tbody>
          {% for row in summary %}
            <tr
              data-region="{{ row.region | lower }}"
              data-department="{{ row.department | lower }}"
              data-pending="{{ row.pending }}"
            >
              <td class="fw-semibold">
                {{ row.region }}
              </td>

              <td>
                <a
                  href="/region/{{ row.region }}/department/{{ row.department }}"
                  class="text-decoration-none fw-semibold"
                >
                  {{ row.department }}
                </a>
              </td>

              <td>{{ row.total }}</td>
              <td class="text-success fw-bold">
                {{ row.integrated }}
              </td>
              <td class="text-danger fw-bold">
                {{ row.pending }}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No data available
              </td>
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

  </div>

</div>




<!-- FILTER + EXPORT SCRIPT -->
<script>
function applyFilters() {
  const region = document.getElementById("filterRegion").value.trim().toLowerCase();
  const dept = document.getElementById("filterDepartment").value.trim().toLowerCase();
  const pendingMin = document.getElementById("filterPending").value;

  document.querySelectorAll("#summaryTable tbody tr").forEach(row => {
    let visible = true;

    const rowRegion = (row.dataset.region || "").trim().toLowerCase();
    const rowDept = (row.dataset.department || "").trim().toLowerCase();
    const rowPending = parseInt(row.dataset.pending || "0");

    if (region && rowRegion !== region) visible = false;
    if (dept && !rowDept.includes(dept)) visible = false;
    if (pendingMin && rowPending < parseInt(pendingMin)) visible = false;

    row.style.display = visible ? "" : "none";
  });
}

document.querySelectorAll(
  "#filterRegion, #filterDepartment, #filterPending"
).forEach(el => el.addEventListener("input", applyFilters));

function resetFilters() {
  document.getElementById("filterRegion").value = "";
  document.getElementById("filterDepartment").value = "";
  document.getElementById("filterPending").value = "";
  applyFilters();
}

function getTimestamp() {
  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  return (
    d.getFullYear() +
    pad(d.getMonth() + 1) +
    pad(d.getDate()) + "_" +
    pad(d.getHours()) +
    pad(d.getMinutes()) +
    pad(d.getSeconds())
  );
}

function exportTable() {
  let csv = [];
  const rows = document.querySelectorAll("#summaryTable tr");

  rows.forEach(row => {
    const cols = row.querySelectorAll("th, td");
    let data = [];

    cols.forEach(col => {
      data.push('"' + col.innerText.replace(/"/g, '""') + '"');
    });

    csv.push(data.join(","));
  });

  const filename = `pims_admin_summary_${getTimestamp()}.csv`;

  const blob = new Blob([csv.join("\n")], {
    type: "text/csv;charset=utf-8;"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

</script>

{% endblock %}
